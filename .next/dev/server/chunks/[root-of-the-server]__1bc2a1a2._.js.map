{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/apple/Downloads/fantasy-web/app/api/nba-stats/route.ts"],"sourcesContent":["// app/api/nba-stats/route.ts\n// 后台预取并缓存 NBA 数据，用户访问时直接返回缓存数据\n\nimport { NextResponse } from \"next/server\";\n\nconst API_BASE = \"https://api.balldontlie.io/v1\";\nconst API_KEY = \"14fd7de0-c9c0-40d3-bbeb-e8c86a61d56a\";\n\n// Fantasy 计分规则\nconst FANTASY_WEIGHTS = {\n  pts: 1,\n  reb: 1,\n  ast: 1,\n  stl: 2,\n  blk: 2,\n  fg3m: 1,\n  tov: -1,\n};\n\n// 内存缓存 (生产环境建议用 Redis/Upstash)\nlet cachedData: {\n  players: any[];\n  gamesLoaded: number;\n  lastUpdated: string;\n  isUpdating: boolean;\n} = {\n  players: [],\n  gamesLoaded: 0,\n  lastUpdated: \"\",\n  isUpdating: false,\n};\n\n// 获取最近 N 天的日期\nfunction getRecentDates(days: number): string[] {\n  const dates: string[] = [];\n  for (let i = 1; i <= days; i++) {\n    const date = new Date();\n    date.setDate(date.getDate() - i);\n    dates.push(date.toISOString().split(\"T\")[0]);\n  }\n  return dates;\n}\n\n// API 请求封装\nasync function fetchAPI(endpoint: string, params?: Record<string, string>) {\n  const url = new URL(`${API_BASE}${endpoint}`);\n  if (params) {\n    Object.entries(params).forEach(([key, value]) => {\n      url.searchParams.append(key, value);\n    });\n  }\n\n  const response = await fetch(url.toString(), {\n    headers: { Authorization: API_KEY },\n    next: { revalidate: 0 }, // 不使用 Next.js 缓存\n  });\n\n  if (!response.ok) {\n    throw new Error(`API Error: ${response.status}`);\n  }\n\n  return response.json();\n}\n\n// 计算 Fantasy Points\nfunction calculateFantasyPoints(stats: any): number {\n  return (\n    (stats.pts || 0) * FANTASY_WEIGHTS.pts +\n    (stats.reb || 0) * FANTASY_WEIGHTS.reb +\n    (stats.ast || 0) * FANTASY_WEIGHTS.ast +\n    (stats.stl || 0) * FANTASY_WEIGHTS.stl +\n    (stats.blk || 0) * FANTASY_WEIGHTS.blk +\n    (stats.fg3m || 0) * FANTASY_WEIGHTS.fg3m +\n    (stats.tov || 0) * FANTASY_WEIGHTS.tov\n  );\n}\n\n// 后台刷新数据\nasync function refreshData() {\n  if (cachedData.isUpdating) {\n    console.log(\"Already updating, skip...\");\n    return;\n  }\n\n  cachedData.isUpdating = true;\n  console.log(\"Starting data refresh...\");\n\n  try {\n    // 1. 获取最近 5 天的已完成比赛\n    const recentDates = getRecentDates(5);\n    const allGames: any[] = [];\n\n    for (const date of recentDates) {\n      const gamesRes = await fetchAPI(\"/games\", { \"dates[]\": date, per_page: \"50\" });\n      const finishedGames = (gamesRes.data || []).filter((g: any) => g.status === \"Final\");\n      allGames.push(...finishedGames);\n      await new Promise((r) => setTimeout(r, 200)); // Rate limit\n    }\n\n    if (allGames.length === 0) {\n      console.log(\"No finished games found\");\n      cachedData.isUpdating = false;\n      return;\n    }\n\n    console.log(`Found ${allGames.length} finished games`);\n\n    // 2. 获取每场比赛的球员统计\n    const playerStatsMap = new Map<number, { player: any; games: any[] }>();\n\n    for (const game of allGames) {\n      try {\n        const statsRes = await fetchAPI(\"/stats\", { \"game_ids[]\": game.id.toString(), per_page: \"100\" });\n        const stats = statsRes.data || [];\n\n        for (const stat of stats) {\n          const playerId = stat.player.id;\n          if (!playerStatsMap.has(playerId)) {\n            playerStatsMap.set(playerId, { player: stat.player, games: [] });\n          }\n          playerStatsMap.get(playerId)!.games.push({ ...stat, team: stat.team });\n        }\n      } catch (e) {\n        console.error(`Failed to fetch stats for game ${game.id}`);\n      }\n      await new Promise((r) => setTimeout(r, 300)); // Rate limit\n    }\n\n    // 3. 获取伤病信息\n    let injuries: any[] = [];\n    try {\n      const injuriesRes = await fetchAPI(\"/player_injuries\", { per_page: \"100\" });\n      injuries = injuriesRes.data || [];\n    } catch (e) {\n      console.log(\"Could not fetch injuries\");\n    }\n\n    const injuryMap = new Map<number, string>();\n    injuries.forEach((inj) => {\n      injuryMap.set(inj.player.id, inj.status);\n    });\n\n    // 4. 计算球员数据\n    const playersData: any[] = [];\n\n    playerStatsMap.forEach(({ player, games }) => {\n      if (games.length === 0) return;\n\n      const totals = games.reduce(\n        (acc, g) => ({\n          min: acc.min + parseFloat(g.min || \"0\"),\n          fgm: acc.fgm + (g.fgm || 0),\n          fga: acc.fga + (g.fga || 0),\n          fg3m: acc.fg3m + (g.fg3m || 0),\n          fg3a: acc.fg3a + (g.fg3a || 0),\n          ftm: acc.ftm + (g.ftm || 0),\n          fta: acc.fta + (g.fta || 0),\n          reb: acc.reb + (g.reb || 0),\n          ast: acc.ast + (g.ast || 0),\n          stl: acc.stl + (g.stl || 0),\n          blk: acc.blk + (g.blk || 0),\n          tov: acc.tov + (g.turnover || 0),\n          pts: acc.pts + (g.pts || 0),\n        }),\n        { min: 0, fgm: 0, fga: 0, fg3m: 0, fg3a: 0, ftm: 0, fta: 0, reb: 0, ast: 0, stl: 0, blk: 0, tov: 0, pts: 0 }\n      );\n\n      const gp = games.length;\n      const averages = {\n        min: totals.min / gp,\n        fgm: totals.fgm / gp,\n        fga: totals.fga / gp,\n        fg3m: totals.fg3m / gp,\n        fg3a: totals.fg3a / gp,\n        ftm: totals.ftm / gp,\n        fta: totals.fta / gp,\n        fg_pct: totals.fga > 0 ? (totals.fgm / totals.fga) * 100 : 0,\n        fg3_pct: totals.fg3a > 0 ? (totals.fg3m / totals.fg3a) * 100 : 0,\n        ft_pct: totals.fta > 0 ? (totals.ftm / totals.fta) * 100 : 0,\n        reb: totals.reb / gp,\n        ast: totals.ast / gp,\n        stl: totals.stl / gp,\n        blk: totals.blk / gp,\n        tov: totals.tov / gp,\n        pts: totals.pts / gp,\n      };\n\n      const fptsTotal = calculateFantasyPoints(totals);\n      const fptsAvg = fptsTotal / gp;\n      const latestGame = games[games.length - 1];\n\n      playersData.push({\n        id: player.id,\n        name: `${player.first_name} ${player.last_name}`,\n        team: latestGame.team?.abbreviation || player.team?.abbreviation || \"N/A\",\n        position: player.position || \"N/A\",\n        gamesPlayed: gp,\n        totals,\n        averages,\n        fpts: Math.round(fptsTotal * 10) / 10,\n        fptsAvg: Math.round(fptsAvg * 10) / 10,\n        rank: 0,\n        injury: injuryMap.get(player.id),\n      });\n    });\n\n    // 5. 排序\n    playersData.sort((a, b) => b.fptsAvg - a.fptsAvg);\n    playersData.forEach((p, i) => {\n      p.rank = i + 1;\n    });\n\n    // 6. 更新缓存\n    cachedData = {\n      players: playersData,\n      gamesLoaded: allGames.length,\n      lastUpdated: new Date().toISOString(),\n      isUpdating: false,\n    };\n\n    console.log(`Data refresh complete: ${playersData.length} players`);\n  } catch (error) {\n    console.error(\"Error refreshing data:\", error);\n    cachedData.isUpdating = false;\n  }\n}\n\n// GET: 返回缓存数据\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const forceRefresh = searchParams.get(\"refresh\") === \"true\";\n\n  // 如果没有数据或者强制刷新，开始后台刷新\n  if (cachedData.players.length === 0 || forceRefresh) {\n    // 异步刷新，不阻塞响应\n    refreshData();\n\n    // 如果完全没有数据，等待第一次加载\n    if (cachedData.players.length === 0) {\n      return NextResponse.json({\n        status: \"loading\",\n        message: \"Data is being loaded for the first time, please wait...\",\n        players: [],\n        gamesLoaded: 0,\n        lastUpdated: null,\n      });\n    }\n  }\n\n  // 检查数据是否过期 (超过 30 分钟自动后台刷新)\n  if (cachedData.lastUpdated) {\n    const lastUpdate = new Date(cachedData.lastUpdated).getTime();\n    const now = Date.now();\n    const thirtyMinutes = 30 * 60 * 1000;\n\n    if (now - lastUpdate > thirtyMinutes && !cachedData.isUpdating) {\n      // 后台刷新，不阻塞\n      refreshData();\n    }\n  }\n\n  return NextResponse.json({\n    status: \"success\",\n    players: cachedData.players,\n    gamesLoaded: cachedData.gamesLoaded,\n    lastUpdated: cachedData.lastUpdated,\n    isUpdating: cachedData.isUpdating,\n  });\n}\n\n// POST: 手动触发刷新\nexport async function POST() {\n  if (cachedData.isUpdating) {\n    return NextResponse.json({\n      status: \"already_updating\",\n      message: \"Data refresh is already in progress\",\n    });\n  }\n\n  // 后台刷新\n  refreshData();\n\n  return NextResponse.json({\n    status: \"refresh_started\",\n    message: \"Data refresh started in background\",\n  });\n}\n"],"names":[],"mappings":"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"}}]
}